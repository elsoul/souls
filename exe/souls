#!/usr/bin/env ruby
require "souls"

begin
  begin
    require "./config/initializers/souls" unless ARGV[0] == "new" || ARGV[0] == "init"
  rescue
    Souls::Init.config_init
  end
  case ARGV[0]
  when "new"
    if ARGV[1].nil?
      puts "you need to specify your app name \n `souls new app_name`"
      exit
    end
    puts "Which framework:   \n 1. SOULS GraphQL API \n 2. SOULS GraphQL API gRPC compatible \n 3. SOULS gRPC Service \n 4. SOULS Media Web \n 5. SOULS Admin Web \n Enter Number: "
    strain = STDIN.gets.chomp.to_i
    (1..5).include?(strain) ? puts("Generating Souls.. \n") : raise(StandardError, "Choose Number 1..5")
    Souls::Init.create_souls strain: strain, app_name: ARGV[1]
  when "s", "server"
    strain = Souls.configuration.strain
    case strain
    when "media", "admin"
      system "yarn dev"
    when "service"
      system "bundle exec rake run_server"
    else
      STDOUT.write `foreman start -f Procfile.dev`
    end
  when "c", "console"
    strain = Souls.configuration.strain
    case strain
    when "media", "admin"
      system "yarn dev"
    else
      STDOUT.write `bundle exec irb`
    end
  when "i", "infra"
    Souls.send ARGV[1]
  when "p", "proto"
    Souls::Init.proto proto_package_name: "souls", service: ARGV[1]
  when "init"
    Souls::Init.config_init
  when "-v", "--version"
    puts Souls::VERSION
  when "g", "generate"
    case ARGV[1]
    when "test_dir"
      Souls::Init.test_dir
    when "node_type"
      Souls::Init.node_type class_name: ARGV[2]
    when "resolver"
      Souls::Init.resolver class_name: ARGV[2]
    when "job"
      Souls::Init.job class_name: ARGV[2]
    when "model"
      Souls::Init.model class_name: ARGV[2]
    when "mutation"
      Souls::Init.mutation class_name: ARGV[2]
    when "query"
      Souls::Init.query class_name: ARGV[2]
    when "type"
      Souls::Init.type class_name: ARGV[2]
    when "migrate"
      Souls::Init.single_migrate class_name: ARGV[2]
    when "migrate_all"
      Souls::Init.migrate_all
    when "migration"
      STDOUT.write `rake db:create_migration NAME=#{ARGV[2]}`
    when "rspec_factory"
      Souls::Init.rspec_factory class_name: ARGV[2]
    when "rspec_model"
      Souls::Init.rspec_model class_name: ARGV[2]
    when "rspec_mutation"
      Souls::Init.rspec_mutation class_name: ARGV[2]
    when "rspec_query"
      Souls::Init.rspec_query class_name: ARGV[2]
    when "rspec_type"
      Souls::Init.rspec_type class_name: ARGV[2]
    else
      "SOULs!"
    end
  when "db:create"
    STDOUT.write `rake db:create && rake db:create RACK_ENV=test`
  when "db:migrate"
    STDOUT.write `rake db:migrate && rake db:migrate RACK_ENV=test`
  when "db:migrate:reset"
    STDOUT.write `rake db:migrate:reset && rake db:migrate:reset RACK_ENV=test`
  when "t", "test"
    STDOUT.write `rubocop`
    STDOUT.write `bundle exec rspec`
  when "run"
    STDOUT.write `docker build . -t souls:latest`
    STDOUT.write `docker run --rm -p 3000:3000 souls:latest`
  when "deploy"
    project_id = Souls.configuration.project_id
    STDOUT.write `gcloud builds submit --config=cloudbuild.yml --project #{project_id}`
  else
    puts "Welcome to SOULs!"
  end
rescue StandardError => error
  puts error.backtrace
  puts "Thank you!!"
  puts "SOULs"
end
